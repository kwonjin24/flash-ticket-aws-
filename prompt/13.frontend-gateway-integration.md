# 프론트엔드 Gateway 통합 작업 가이드

## 개요
백엔드 아키텍처 변경에 따라 **Gateway** 서비스가 인증(Auth)과 대기열(Queue)을 전담하게 되었습니다.
프론트엔드는 이에 맞춰 API 엔드포인트를 재설정하고, WebSocket 연결을 Gateway로 변경해야 합니다.

## 현재 상태 분석

### 1. 현재 API 구조
- `web/src/api/http.ts`: 단일 `API_BASE_URL` 사용 (환경변수: `VITE_API_BASE_URL`)
- `web/src/api/queueSocket.ts`: WebSocket 연결을 `${API_BASE_URL}/queue`로 설정
- `web/src/App.tsx`: 인증 API 호출 (`auth/login`, `auth/register`, `auth/register/admin`)

### 2. 변경 필요 사항
Gateway와 API 서버가 분리되었으므로:
- **Gateway**: `/auth/*`, `/queue/*` (REST + WebSocket)
- **API**: `/events/*`, `/orders/*`, `/payments/*` (비즈니스 로직)

---

## 작업 목록

### Phase 1: 환경 변수 및 설정 분리

#### 1.1 환경 변수 추가
**파일**: `web/.env.development`, `web/.env.production` (없으면 생성)

```bash
# Gateway 서비스 (인증 + 대기열)
VITE_GATEWAY_BASE_URL=http://localhost:3000

# API 서비스 (비즈니스 로직)
VITE_API_BASE_URL=http://localhost:4000
```

**프로덕션 환경**:
```bash
VITE_GATEWAY_BASE_URL=https://api.highgarden.cloud
VITE_API_BASE_URL=https://api.highgarden.cloud
```

**참고**: Nginx 리버스 프록시 설정에 따라 동일 도메인에서 경로로 라우팅될 수 있음.

---

### Phase 2: API 클라이언트 리팩토링

#### 2.1 HTTP 클라이언트 분리
**파일**: `web/src/api/http.ts`

**변경 전**:
```typescript
export const API_BASE_URL = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:4000'
export const http = ky.create({ prefixUrl: API_BASE_URL.replace(/\/$/, ''), ... })
```

**변경 후**:
```typescript
export const GATEWAY_BASE_URL = import.meta.env.VITE_GATEWAY_BASE_URL ?? 'http://localhost:3000'
export const API_BASE_URL = import.meta.env.VITE_API_BASE_URL ?? 'http://localhost:4000'

// Gateway 전용 클라이언트 (인증 + 대기열)
export const gatewayHttp = ky.create({
  prefixUrl: GATEWAY_BASE_URL.replace(/\/$/, ''),
  hooks: {
    beforeRequest: [
      (request) => {
        const { accessToken } = useAuthStore.getState()
        if (accessToken) {
          request.headers.set('Authorization', `Bearer ${accessToken}`)
        }
      },
    ],
  },
  retry: { limit: 0 },
})

// API 전용 클라이언트 (비즈니스 로직)
export const http = ky.create({
  prefixUrl: API_BASE_URL.replace(/\/$/, ''),
  hooks: {
    beforeRequest: [
      (request) => {
        const { accessToken } = useAuthStore.getState()
        if (accessToken) {
          request.headers.set('Authorization', `Bearer ${accessToken}`)
        }
      },
    ],
    afterResponse: [
      async (request, options, response) => {
        if (response.ok) return response

        if ((response.status === 401 || response.status === 403) && !gateTokenErrorHandled) {
          try {
            const data = await response.clone().json()
            const message = Array.isArray(data?.message)
              ? data.message.join(', ')
              : typeof data?.message === 'string'
                ? data.message
                : ''
            if (message.toLowerCase().includes('gate token')) {
              gateTokenErrorHandled = true
              await handleGateTokenError(response)
            }
          } catch {
            // ignore
          }
        }

        throw new HTTPError(response, request, options)
      },
    ],
  },
  retry: { limit: 0 },
})
```

**핵심 변경점**:
- `gatewayHttp`: 인증 및 대기열 전용 (Gate Token 에러 처리 없음)
- `http`: 기존 API 유지 (Gate Token 에러 처리 포함)

---

#### 2.2 WebSocket 엔드포인트 변경
**파일**: `web/src/api/queueSocket.ts`

**변경 전**:
```typescript
import { API_BASE_URL } from './http'
const endpoint = `${API_BASE_URL.replace(/\/$/, '')}/queue`
```

**변경 후**:
```typescript
import { GATEWAY_BASE_URL } from './http'

export const createQueueSocket = (handlers: QueueSocketHandlers): Socket => {
  if (queueSocket) {
    return queueSocket
  }

  const endpoint = GATEWAY_BASE_URL.replace(/\/$/, '')
  queueSocket = io(endpoint, {
    path: '/socket.io/',
    transports: ['websocket'],
    withCredentials: true,
    autoConnect: true,
  })

  // ... 나머지 코드 동일
}
```

**참고**:
- `path`를 명시적으로 `/socket.io/`로 설정
- namespace는 서버에서 자동 처리 (현재 구조 유지)

---

### Phase 3: 인증 API 호출 변경

#### 3.1 App.tsx 수정
**파일**: `web/src/App.tsx`

**변경 전**:
```typescript
import { http } from './api/http'

const login = async (credentials: LoginCredentials) => {
  const response = await http.post('auth/login', { json: credentials }).json<TokenDto>()
  // ...
}

const register = async (credentials: RegisterCredentials) => {
  if (credentials.isAdmin) {
    await http.post('auth/register/admin', { ... })
  } else {
    await http.post('auth/register', { ... })
  }
}
```

**변경 후**:
```typescript
import { http, gatewayHttp } from './api/http'

const login = async (credentials: LoginCredentials) => {
  const response = await gatewayHttp.post('auth/login', { json: credentials }).json<TokenDto>()
  const { userId, userUuid, role } = decodeToken(response.accessToken)
  if (!userUuid) {
    throw new Error('토큰에서 사용자 정보를 추출할 수 없습니다.')
  }
  setSession({
    accessToken: response.accessToken,
    refreshToken: response.refreshToken ?? null,
    userId,
    userUuid,
    role,
  })
}

const register = async (credentials: RegisterCredentials) => {
  if (credentials.isAdmin) {
    await gatewayHttp.post('auth/register/admin', {
      json: { userId: credentials.userId, password: credentials.password, adminSecret: credentials.adminSecret },
    })
  } else {
    await gatewayHttp.post('auth/register', {
      json: { userId: credentials.userId, password: credentials.password },
    })
  }
  await login({ userId: credentials.userId, password: credentials.password })
}
```

---

#### 3.2 토큰 갱신 로직 추가 (선택 사항)
**파일**: `web/src/api/http.ts` 또는 `web/src/utils/token.ts`

Refresh Token을 사용하는 경우:
```typescript
export const refreshAccessToken = async (): Promise<string | null> => {
  const { refreshToken, setSession, clear } = useAuthStore.getState()
  if (!refreshToken) return null

  try {
    const response = await gatewayHttp.post('auth/refresh', {
      json: { refreshToken },
    }).json<TokenDto>()

    const { userId, userUuid, role } = decodeToken(response.accessToken)
    setSession({
      accessToken: response.accessToken,
      refreshToken: response.refreshToken ?? refreshToken,
      userId,
      userUuid,
      role,
    })

    return response.accessToken
  } catch {
    clear()
    return null
  }
}
```

---

### Phase 4: 대기열 관련 API 호출 변경

#### 4.1 Queue Store 수정 필요 확인
**파일**: `web/src/store/queue.ts`

대기열 REST API 호출이 있는지 확인 후, 있다면 `gatewayHttp` 사용:
```typescript
import { gatewayHttp } from '../api/http'

// 예시: 대기열 입장
export const enqueueTicket = async (eventId: string) => {
  return await gatewayHttp.post('queue/enqueue', {
    json: { eventId },
  }).json()
}

// 예시: 대기열 상태 조회
export const getQueueStatus = async (ticketId: string) => {
  return await gatewayHttp.get(`queue/status?ticketId=${ticketId}`).json()
}
```

---

### Phase 5: 타입 정의 및 유틸리티 확인

#### 5.1 타입 확인
**파일**: `web/src/types/auth.ts`

현재 타입이 백엔드 변경사항과 일치하는지 확인:
```typescript
export interface TokenDto {
  accessToken: string
  refreshToken?: string
}

export interface LoginCredentials {
  userId: string
  password: string
}

export interface RegisterCredentials {
  userId: string
  password: string
  confirmPassword: string
  isAdmin: boolean
  adminSecret: string
}
```

---

## 검증 사항

### 1. 로컬 개발 환경 검증

#### 1.1 인증 플로우
- [ ] **회원가입 (일반 사용자)**
  - `POST /auth/register` → Gateway 호출 확인
  - 회원가입 후 자동 로그인 동작 확인
  - 토큰이 정상적으로 저장되는지 확인 (`localStorage` 체크)

- [ ] **회원가입 (관리자)**
  - `POST /auth/register/admin` → Gateway 호출 확인
  - 관리자 비밀키 검증 동작 확인

- [ ] **로그인**
  - `POST /auth/login` → Gateway 호출 확인
  - Access Token과 Refresh Token 반환 확인
  - JWT 디코딩 후 `userUuid`, `role` 추출 확인

- [ ] **토큰 갱신** (Refresh Token 구현 시)
  - `POST /auth/refresh` → Gateway 호출 확인
  - 새로운 Access Token 발급 확인

- [ ] **로그아웃**
  - `POST /auth/logout` → Gateway 호출 확인 (구현되어 있다면)
  - 로컬 스토리지 토큰 삭제 확인

---

#### 1.2 대기열 플로우
- [ ] **대기열 입장**
  - `POST /queue/enqueue` → Gateway 호출 확인
  - JWT 토큰이 헤더에 포함되는지 확인

- [ ] **대기열 상태 조회**
  - `GET /queue/status?ticketId=...` → Gateway 호출 확인

- [ ] **WebSocket 연결**
  - WebSocket이 Gateway URL로 연결되는지 확인
  - 브라우저 개발자 도구 → Network 탭에서 `ws://` 또는 `wss://` 연결 확인
  - 네임스페이스가 올바른지 확인 (예: `/socket.io/?EIO=4&transport=websocket`)

- [ ] **실시간 이벤트 수신**
  - `queue:config` 이벤트 수신 확인
  - `queue:update` 이벤트로 대기열 상태 업데이트 확인
  - `queue:summary` 이벤트 수신 확인
  - `queue:error` 이벤트 발생 시 에러 처리 확인

---

#### 1.3 비즈니스 로직 (API 서버)
- [ ] **이벤트 조회**
  - `GET /events` → API 서버 호출 확인
  - Gateway에서 발급한 토큰으로 접근 가능한지 확인

- [ ] **주문 생성**
  - `POST /orders` → API 서버 호출 확인
  - Gate Token이 필요한 경우 정상 동작 확인

- [ ] **결제 처리**
  - `POST /payments` → API 서버 호출 확인

- [ ] **Gate Token 에러 처리**
  - Gate Token 만료 시 에러 메시지 표시 확인
  - 자동 로그인 페이지 리다이렉트 확인

---

### 2. 프로덕션 환경 검증

#### 2.1 Nginx 라우팅 확인
- [ ] `https://gateway.highgarden.cloud/auth/*` → Gateway로 프록시
- [ ] `https://gateway.highgarden.cloud/queue/*` → Gateway로 프록시
- [ ] `https://api.highgarden.cloud/events/*` → API 서버로 프록시
- [ ] `https://api.highgarden.cloud/orders/*` → API 서버로 프록시
- [ ] `https://api.highgarden.cloud/payments/*` → API 서버로 프록시
- [ ] WebSocket 연결: `wss://gateway.highgarden.cloud/socket.io/` → Gateway로 프록시

#### 2.2 CORS 설정
- [ ] Gateway: 프론트엔드 도메인 허용 확인
- [ ] API: 프론트엔드 도메인 허용 확인
- [ ] WebSocket: `withCredentials: true` 동작 확인

#### 2.3 HTTPS/WSS
- [ ] HTTPS 인증서 적용 확인
- [ ] WebSocket이 WSS로 연결되는지 확인

---

### 3. 에러 핸들링 검증

#### 3.1 인증 실패
- [ ] 잘못된 아이디/비밀번호 입력 시 에러 메시지 표시
- [ ] 401 Unauthorized 시 로그인 페이지로 리다이렉트

#### 3.2 네트워크 에러
- [ ] Gateway 서버 다운 시 에러 메시지 표시
- [ ] API 서버 다운 시 에러 메시지 표시
- [ ] WebSocket 연결 끊김 시 재연결 시도 (socket.io 자동 처리)

#### 3.3 토큰 만료
- [ ] Access Token 만료 시 Refresh Token으로 갱신 (구현된 경우)
- [ ] Refresh Token 만료 시 로그아웃 처리

---

## 주의 사항

### 1. 환경 변수 우선순위
- `.env.local` > `.env.production` > `.env.development` > `.env`
- Git에 `.env.local` 커밋하지 않도록 주의

### 2. 하위 호환성
- 기존 API 서버가 Gateway 없이 단독으로 동작하는 경우를 고려해 환경변수에 fallback 제공
- 개발 환경과 프로덕션 환경의 URL이 다를 수 있음

### 3. 보안
- `withCredentials: true` 설정 시 CORS preflight 요청 발생 가능
- 프로덕션 환경에서는 반드시 HTTPS/WSS 사용

### 4. 성능
- 동일 도메인 사용 시 HTTP/2 multiplexing 활용 가능
- Gateway와 API가 다른 서버인 경우 latency 증가 고려

---

## 롤백 계획

작업 중 문제 발생 시:
1. 환경변수를 단일 `VITE_API_BASE_URL`로 복원
2. `http.ts`에서 `gatewayHttp` 제거하고 기존 `http` 클라이언트로 통합
3. `App.tsx`의 `gatewayHttp` 호출을 `http`로 변경
4. WebSocket 엔드포인트를 `${API_BASE_URL}/queue`로 복원

---

## 참고 문서
- `/prompt/11.queue-gateway.md`: Queue Gateway 분리 작업 정리
- `/prompt/12.auth-gateway-plan.md`: Gateway 인증/토큰 전담 전환 작업 계획
- `RUNTIME_ENV.md`: 런타임 환경 변수 설정
- `DEV_DEPLOYMENT.md`: 개발 환경 배포 가이드

---

## 완료 체크리스트

- [ ] 환경 변수 파일 생성 및 설정
- [ ] `http.ts` 리팩토링 (gatewayHttp 추가)
- [ ] `queueSocket.ts` WebSocket 엔드포인트 변경
- [ ] `App.tsx` 인증 API 호출 변경
- [ ] Queue Store REST API 호출 변경 (있는 경우)
- [ ] 로컬 환경 검증 (인증/대기열/비즈니스 로직)
- [ ] 프로덕션 환경 배포 및 검증
- [ ] 에러 핸들링 테스트
- [ ] 문서 업데이트 (README, 배포 가이드 등)
