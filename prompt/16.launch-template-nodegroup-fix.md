# Launch Template 생성을 통한 노드 그룹 보안 그룹 자동 할당 설정

## 목표
EKS 노드 그룹에 Launch Template을 적용하여, 오토스케일링 시 자동으로 필수 보안 그룹이 할당되도록 설정

## 배경
- 현재 노드 그룹은 Launch Template 없이 생성됨
- 새 노드 추가 시 `flash-tickets-eks-nodes-sg` 보안 그룹이 자동 할당 안됨
- Redis, RabbitMQ 등 외부 리소스 접근 불가 문제 발생

---

## 현재 상태 확인

### 1. 기존 노드 그룹 정보
```bash
# 노드 그룹 상세 정보
aws eks describe-nodegroup \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes \
  --region ap-northeast-2 \
  --output json > /tmp/current-nodegroup.json

# 주요 설정 확인
cat /tmp/current-nodegroup.json | jq '{
  nodegroupName: .nodegroup.nodegroupName,
  instanceTypes: .nodegroup.instanceTypes,
  scalingConfig: .nodegroup.scalingConfig,
  subnets: .nodegroup.subnets,
  launchTemplate: .nodegroup.launchTemplate,
  amiType: .nodegroup.amiType,
  releaseVersion: .nodegroup.releaseVersion
}'
```

**예상 출력**:
```json
{
  "nodegroupName": "flash-tickets-nodes",
  "instanceTypes": ["t3.medium", "t3a.medium"],
  "scalingConfig": {
    "minSize": 1,
    "maxSize": 4,
    "desiredSize": 3
  },
  "subnets": [
    "subnet-09b8ac857209350cc",
    "subnet-0c110de21c619a794"
  ],
  "launchTemplate": null,  // ← 문제!
  "amiType": "AL2_x86_64",
  "releaseVersion": "1.33.5-20250126"
}
```

### 2. 필수 보안 그룹 확인
```bash
# 클러스터 보안 그룹
aws eks describe-cluster \
  --name flash-tickets-eks \
  --region ap-northeast-2 \
  --query 'cluster.resourcesVpcConfig.clusterSecurityGroupId' \
  --output text

# 출력: sg-06bf5f46ace325ef6

# 노드 보안 그룹 (수동 확인)
# sg-0e5a96d33de056bfe (flash-tickets-eks-nodes-sg)
```

### 3. 현재 노드 보안 그룹 상태 확인
```bash
kubectl get nodes -o json | \
  jq -r '.items[] | "\(.metadata.name) | \(.spec.providerID)"' | \
  while read line; do
    NODE_NAME=$(echo $line | cut -d'|' -f1 | xargs)
    INSTANCE_ID=$(echo $line | cut -d'/' -f5)
    echo "=== $NODE_NAME ==="
    aws ec2 describe-instances \
      --instance-ids $INSTANCE_ID \
      --region ap-northeast-2 \
      --query 'Reservations[0].Instances[0].SecurityGroups[*].[GroupId,GroupName]' \
      --output table
    echo ""
  done
```

---

## 작업 1: Launch Template 생성

### 1-1. 최신 EKS 최적화 AMI 확인
```bash
# Kubernetes 1.33용 Amazon Linux 2 AMI
AMI_ID=$(aws ssm get-parameter \
  --name /aws/service/eks/optimized-ami/1.33/amazon-linux-2/recommended/image_id \
  --region ap-northeast-2 \
  --query 'Parameter.Value' \
  --output text)

echo "AMI ID: $AMI_ID"

# AMI 정보 확인
aws ssm get-parameter \
  --name /aws/service/eks/optimized-ami/1.33/amazon-linux-2/recommended \
  --region ap-northeast-2 \
  --query 'Parameter.Value' \
  --output text | jq
```

### 1-2. Launch Template 생성
```bash
aws ec2 create-launch-template \
  --launch-template-name flash-tickets-nodes-lt \
  --version-description "EKS node group launch template with security groups" \
  --region ap-northeast-2 \
  --launch-template-data '{
    "ImageId": "'${AMI_ID}'",
    "SecurityGroupIds": [
      "sg-06bf5f46ace325ef6",
      "sg-0e5a96d33de056bfe"
    ],
    "TagSpecifications": [
      {
        "ResourceType": "instance",
        "Tags": [
          {
            "Key": "Name",
            "Value": "flash-tickets-eks-node"
          },
          {
            "Key": "kubernetes.io/cluster/flash-tickets-eks",
            "Value": "owned"
          },
          {
            "Key": "Environment",
            "Value": "production"
          }
        ]
      }
    ],
    "MetadataOptions": {
      "HttpTokens": "required",
      "HttpPutResponseHopLimit": 2
    },
    "Monitoring": {
      "Enabled": true
    }
  }'
```

**중요 파라미터 설명**:
- `ImageId`: EKS 최적화 AMI (버전 일치 필수)
- `SecurityGroupIds`: **클러스터 SG + 노드 SG** 모두 포함
- `MetadataOptions.HttpTokens`: IMDSv2 강제 (보안 강화)
- `MetadataOptions.HttpPutResponseHopLimit`: Pod가 메타데이터 접근 가능하도록 설정
- `Monitoring`: CloudWatch 상세 모니터링 활성화

### 1-3. Launch Template 확인
```bash
aws ec2 describe-launch-template-versions \
  --launch-template-name flash-tickets-nodes-lt \
  --region ap-northeast-2 \
  --query 'LaunchTemplateVersions[0]' | jq
```

---

## 작업 2: 새 노드 그룹 생성 (Blue-Green 방식)

### 2-1. 새 노드 그룹 생성
```bash
# IAM Role 확인 (기존 노드 그룹과 동일)
NODEGROUP_ROLE=$(aws eks describe-nodegroup \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes \
  --region ap-northeast-2 \
  --query 'nodegroup.nodeRole' \
  --output text)

echo "NodeGroup Role: $NODEGROUP_ROLE"

# 새 노드 그룹 생성
aws eks create-nodegroup \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes-v2 \
  --scaling-config minSize=2,maxSize=4,desiredSize=3 \
  --subnets subnet-09b8ac857209350cc subnet-0c110de21c619a794 \
  --instance-types t3.medium t3a.medium \
  --node-role $NODEGROUP_ROLE \
  --launch-template name=flash-tickets-nodes-lt,version='$Latest' \
  --region ap-northeast-2 \
  --labels environment=production,nodegroup=v2 \
  --tags "Name=flash-tickets-node-v2,Environment=production,ManagedBy=eks"
```

**파라미터 설명**:
- `nodegroup-name`: 새 이름 (기존과 구분)
- `launch-template`: 위에서 생성한 템플릿 사용
- `version='$Latest'`: 항상 최신 버전 사용
- `labels`: Pod affinity/anti-affinity에 활용 가능
- `scaling-config`: 기존과 동일하게 설정

### 2-2. 생성 상태 모니터링
```bash
# 노드 그룹 상태 확인
watch -n 5 'aws eks describe-nodegroup \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes-v2 \
  --region ap-northeast-2 \
  --query "nodegroup.status" \
  --output text'

# 또는
aws eks describe-nodegroup \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes-v2 \
  --region ap-northeast-2 \
  --query 'nodegroup.{Status:status,Health:health}' \
  --output table
```

**예상 상태 변화**:
- `CREATING` (10-15분 소요)
- `ACTIVE` (완료)

### 2-3. 새 노드 확인
```bash
# Kubernetes 노드 확인
kubectl get nodes -l nodegroup=v2

# 보안 그룹 확인
kubectl get nodes -l nodegroup=v2 -o json | \
  jq -r '.items[0].spec.providerID' | \
  cut -d'/' -f5 | \
  xargs -I {} aws ec2 describe-instances \
    --instance-ids {} \
    --region ap-northeast-2 \
    --query 'Reservations[0].Instances[0].SecurityGroups[*].[GroupId,GroupName]' \
    --output table
```

**기대 결과**:
```
------------------------------------------------------------------------
|                        DescribeInstances                             |
+-----------------------+----------------------------------------------+
|  sg-06bf5f46ace325ef6 |  eks-cluster-sg-flash-tickets-eks-637059658  |
|  sg-0e5a96d33de056bfe |  flash-tickets-eks-nodes-sg                  |
+-----------------------+----------------------------------------------+
```

---

## 작업 3: Pod 트래픽 전환 및 검증

### 3-1. 새 노드에 Pod 스케줄링 테스트
```bash
# 테스트용 Pod 배포 (새 노드에만)
kubectl run test-pod \
  --image=busybox:latest \
  --restart=Never \
  --overrides='{
    "spec": {
      "nodeSelector": {
        "nodegroup": "v2"
      },
      "containers": [{
        "name": "test",
        "image": "busybox:latest",
        "command": ["sleep", "3600"]
      }]
    }
  }' \
  -n flash-ticket

# Pod가 새 노드에 스케줄링되었는지 확인
kubectl get pod test-pod -n flash-ticket -o wide

# 네트워크 연결 테스트 (Redis)
kubectl exec -n flash-ticket test-pod -- \
  nc -zv master.flash-tickets-redis.rrzszk.apn2.cache.amazonaws.com 6379

# 테스트 Pod 삭제
kubectl delete pod test-pod -n flash-ticket
```

### 3-2. 기존 노드 Cordon (새 Pod 스케줄링 차단)
```bash
# 기존 노드 그룹 노드 확인
kubectl get nodes -l nodegroup!=v2

# Cordon 실행 (새 Pod 배치 차단, 기존 Pod는 유지)
kubectl get nodes -l nodegroup!=v2 -o name | xargs kubectl cordon
```

### 3-3. 점진적 Pod 마이그레이션
```bash
# API Pod 1개씩 재시작
kubectl get pods -n flash-ticket -l app=flash-api -o name | head -1 | xargs kubectl delete -n flash-ticket

# 새 노드에 생성되는지 확인
kubectl get pods -n flash-ticket -l app=flash-api -o wide

# 헬스체크 확인
kubectl get pods -n flash-ticket -l app=flash-api -w
```

### 3-4. 전체 서비스 점검
```bash
# 모든 Pod가 Ready 상태인지 확인
kubectl get pods -n flash-ticket

# 노드별 Pod 분포 확인
kubectl get pods -n flash-ticket -o wide | \
  awk 'NR==1 || /ip-10-0/ {print $0}' | \
  sort -k7
```

---

## 작업 4: 기존 노드 그룹 제거

### 4-1. 기존 노드 Drain
```bash
# 기존 노드에서 모든 Pod 제거 (새 노드로 이동)
kubectl get nodes -l nodegroup!=v2 -o name | \
  xargs -I {} kubectl drain {} \
    --ignore-daemonsets \
    --delete-emptydir-data \
    --timeout=300s \
    --grace-period=30
```

**주의사항**:
- `--ignore-daemonsets`: kube-proxy, aws-node 등 무시
- `--delete-emptydir-data`: emptyDir 볼륨 데이터 삭제 (확인 필요)
- `--grace-period=30`: Pod가 정상 종료될 시간 부여

### 4-2. 기존 노드 그룹 삭제
```bash
# 노드 그룹 삭제
aws eks delete-nodegroup \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes \
  --region ap-northeast-2

# 삭제 상태 모니터링
watch -n 10 'aws eks describe-nodegroup \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes \
  --region ap-northeast-2 \
  --query "nodegroup.status" \
  --output text 2>&1'
```

**예상 상태**:
- `DELETING` (5-10분)
- `Error: ResourceNotFoundException` (완전 삭제)

### 4-3. 정리 확인
```bash
# 노드 그룹 목록
aws eks list-nodegroups \
  --cluster-name flash-tickets-eks \
  --region ap-northeast-2

# Kubernetes 노드 확인
kubectl get nodes

# 모든 노드가 v2인지 확인
kubectl get nodes --show-labels | grep nodegroup
```

---

## 작업 5: 최종 검증

### 5-1. 서비스 헬스체크
```bash
# 모든 Pod 상태
kubectl get pods -n flash-ticket

# API 헬스체크
kubectl run curl-test --image=curlimages/curl:latest --rm -it --restart=Never -- \
  curl -s http://flash-api.flash-ticket.svc.cluster.local:4000/health

# Gateway 헬스체크
kubectl run curl-test --image=curlimages/curl:latest --rm -it --restart=Never -- \
  curl -s http://flash-gateway.flash-ticket.svc.cluster.local:3000/queue/healthz
```

### 5-2. Redis/RabbitMQ 연결 확인
```bash
# API Pod 로그에서 Redis 연결 확인
kubectl logs -n flash-ticket -l app=flash-api --tail=50 | grep -i redis

# Pay Pod 로그에서 RabbitMQ 연결 확인
kubectl logs -n flash-ticket -l app=flash-pay --tail=50 | grep -i rabbitmq
```

### 5-3. 오토스케일링 테스트
```bash
# 노드 그룹 desired 늘리기
aws eks update-nodegroup-config \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes-v2 \
  --scaling-config minSize=2,maxSize=4,desiredSize=4 \
  --region ap-northeast-2

# 새 노드 생성 모니터링
watch -n 5 'kubectl get nodes'

# 새 노드 보안 그룹 확인
kubectl get nodes -o json | \
  jq -r '.items[-1].spec.providerID' | \
  cut -d'/' -f5 | \
  xargs -I {} aws ec2 describe-instances \
    --instance-ids {} \
    --region ap-northeast-2 \
    --query 'Reservations[0].Instances[0].SecurityGroups[*].GroupId' \
    --output text

# 다시 원래대로 줄이기
aws eks update-nodegroup-config \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes-v2 \
  --scaling-config minSize=2,maxSize=4,desiredSize=3 \
  --region ap-northeast-2
```

---

## 롤백 계획

### 문제 발생 시 롤백
```bash
# 1. 새 노드 그룹 Cordon
kubectl get nodes -l nodegroup=v2 -o name | xargs kubectl cordon

# 2. 기존 노드 그룹 Uncordon (이미 삭제하지 않았다면)
kubectl get nodes -l nodegroup!=v2 -o name | xargs kubectl uncordon

# 3. Pod 재배포
kubectl rollout restart deployment/flash-api -n flash-ticket
kubectl rollout restart deployment/flash-gateway -n flash-ticket

# 4. 새 노드 그룹 삭제
aws eks delete-nodegroup \
  --cluster-name flash-tickets-eks \
  --nodegroup-name flash-tickets-nodes-v2 \
  --region ap-northeast-2

# 5. Launch Template 삭제
aws ec2 delete-launch-template \
  --launch-template-name flash-tickets-nodes-lt \
  --region ap-northeast-2
```

---

## 주의사항

### ⚠️ 작업 전 체크리스트
- [ ] 작업 시간대 확인 (트래픽 적은 시간)
- [ ] EKS 클러스터 버전과 AMI 버전 일치 확인
- [ ] IAM Role 권한 확인
- [ ] 백업: Pod 상태, ConfigMap, Secret
- [ ] 모니터링 대시보드 준비

### ⚠️ 작업 중 주의사항
- Launch Template AMI는 반드시 현재 노드와 같은 버전 사용
- 노드 그룹 생성에는 10-15분 소요 (인내심 필요)
- Drain 시 PDB(Pod Disruption Budget) 확인
- 최소 1개 노드는 항상 Running 유지

### ⚠️ 검증 포인트
- 새 노드의 보안 그룹 2개 확인 필수
- Redis/RabbitMQ 연결 정상 확인
- Ingress 트래픽 정상 확인
- 로그에서 에러 없는지 확인

---

## 예상 소요 시간
- Launch Template 생성: 5분
- 새 노드 그룹 생성: 10-15분
- Pod 마이그레이션: 10분
- 기존 노드 그룹 제거: 10분
- 검증: 10분

**총 소요 시간: 약 45-60분**

---

## 완료 후 확인 사항
- [ ] 모든 노드에 보안 그룹 2개 할당됨
- [ ] 모든 Pod가 Running 상태
- [ ] Redis/RabbitMQ 연결 정상
- [ ] 외부 서비스 접근 정상
- [ ] 오토스케일링 시 보안 그룹 자동 할당 확인
- [ ] Launch Template 정보 문서화
- [ ] 모니터링 알람 정상 작동 확인
