# ArgoCD 기반 CI/CD 파이프라인 구성 계획

## 프로젝트 개요
Flash Tickets 모노레포 프로젝트에 ArgoCD 기반 GitOps CI/CD 파이프라인 구축

### 현재 아키텍처
- **서비스**: API (NestJS), Gateway (NestJS), Pay Worker (NestJS), Web (Next.js)
- **인프라**: AWS EKS, ECR, RDS, ElastiCache, RabbitMQ
- **배포 현황**: 수동 배포, eks/, k8s/ 디렉토리 혼재

---

## Phase 1: ArgoCD 설치 및 초기 설정

### 1.1 ArgoCD 클러스터 설치
```bash
# ArgoCD 네임스페이스 생성 및 설치
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# ArgoCD CLI 설치 (macOS)
brew install argocd

# 초기 admin 비밀번호 확인
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
```

### 1.2 ArgoCD Ingress 설정
- ALB Ingress Controller 활용
- TLS 인증서 설정 (ACM)
- 도메인: `argocd.flash-tickets.com` (예시)

**파일**: `eks/argocd/argocd-ingress.yaml`

### 1.3 RBAC 설정
- GitHub 조직 연동 (OAuth)
- 개발자/운영자 권한 분리
- Read-only 접근 권한 설정

**파일**: `eks/argocd/argocd-rbac-cm.yaml`

---

## Phase 2: GitOps 저장소 구조 설계

### 2.1 저장소 전략 결정

**권장: 별도 GitOps 저장소 생성**
```
flash-tickets-gitops/
├── README.md
├── apps/                          # 애플리케이션 매니페스트
│   ├── api/
│   │   ├── base/
│   │   │   ├── kustomization.yaml
│   │   │   ├── deployment.yaml
│   │   │   ├── service.yaml
│   │   │   └── hpa.yaml
│   │   └── overlays/
│   │       ├── dev/
│   │       │   ├── kustomization.yaml
│   │       │   └── patches.yaml
│   │       ├── staging/
│   │       └── prod/
│   ├── gateway/
│   ├── pay/
│   └── web/
├── argocd-apps/                   # ArgoCD Application 정의
│   ├── app-of-apps.yaml          # Root Application
│   ├── api-app.yaml
│   ├── gateway-app.yaml
│   ├── pay-app.yaml
│   └── web-app.yaml
├── infrastructure/                 # 공통 인프라
│   ├── namespaces/
│   ├── ingress/
│   │   └── flash-tickets-ingress.yaml
│   ├── monitoring/
│   │   ├── prometheus/
│   │   └── grafana/
│   └── external-secrets/
└── configs/                       # ConfigMap (Secret은 제외)
    ├── api-config.yaml
    ├── gateway-config.yaml
    └── web-config.yaml
```

### 2.2 현재 매니페스트 마이그레이션
- `eks/deployments/` → `apps/*/base/`
- `eks/configs/` → `configs/` (Secret 제외)
- `eks/ingress/` → `infrastructure/ingress/`

### 2.3 Kustomize 구조 변환
각 서비스별 `base`와 `overlays` 분리
- base: 공통 설정
- overlays: 환경별 차이 (replicas, resources, env vars)

---

## Phase 3: Secret 관리 강화

### 3.1 현재 문제점
- `eks/configs/*-secret.yaml` 평문 저장 (보안 위험!)
- Git에 민감 정보 노출

### 3.2 해결 방안: Sealed Secrets (권장)

**설치**:
```bash
kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml

# Kubeseal CLI 설치
brew install kubeseal
```

**사용법**:
```bash
# 기존 Secret을 SealedSecret으로 변환
kubectl create secret generic api-secret \
  --from-literal=DATABASE_URL=postgresql://... \
  --dry-run=client -o yaml | \
  kubeseal -o yaml > api-sealed-secret.yaml

# Git에 안전하게 커밋
git add api-sealed-secret.yaml
```

### 3.3 대안: External Secrets Operator + AWS Secrets Manager
- AWS Secrets Manager에 시크릿 저장
- External Secrets Operator가 자동 동기화
- 더 높은 보안, 중앙 관리 가능

**트레이드오프**:
- Sealed Secrets: 간단, 빠름, Git 완전 통합
- External Secrets: 복잡, AWS 의존성, 중앙 관리 우수

---

## Phase 4: GitHub Actions CI 파이프라인

### 4.1 변경 감지 및 빌드 전략

**파일**: `.github/workflows/ci-cd.yaml`

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      gateway: ${{ steps.filter.outputs.gateway }}
      pay: ${{ steps.filter.outputs.pay }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            api:
              - 'api/**'
              - 'libs/**'
              - 'Dockerfile.api'
            gateway:
              - 'gateway/**'
              - 'libs/**'
              - 'Dockerfile.gateway'
            pay:
              - 'pay/**'
              - 'libs/**'
              - 'Dockerfile.pay'
            web:
              - 'web/**'
              - 'Dockerfile.web'

  build-api:
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2
      - name: Login to ECR
        run: aws ecr get-login-password | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
      - name: Build and push
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker buildx build --platform linux/amd64 \
            -t ${{ secrets.ECR_REGISTRY }}/flash-tickets-api:${IMAGE_TAG} \
            -t ${{ secrets.ECR_REGISTRY }}/flash-tickets-api:latest \
            -f Dockerfile.api \
            --push .
      - name: Update GitOps repo
        run: |
          # GitOps 저장소에 이미지 태그 업데이트
          # (별도 스크립트로 구현)

  # build-gateway, build-pay, build-web (동일 패턴)
```

### 4.2 이미지 태깅 전략
- **Git SHA**: `${{ github.sha }}` (7자리 단축 가능)
- **Semantic Version**: `v1.2.3` (릴리스 시)
- **Latest**: 개발 편의용 (프로덕션 비권장)

### 4.3 GitOps 저장소 자동 업데이트
```bash
# scripts/update-gitops-image.sh
#!/bin/bash
SERVICE=$1
IMAGE_TAG=$2
ENV=$3

cd flash-tickets-gitops
git checkout main
cd apps/${SERVICE}/overlays/${ENV}
kustomize edit set image flash-tickets-${SERVICE}=${ECR_REGISTRY}/flash-tickets-${SERVICE}:${IMAGE_TAG}
git add .
git commit -m "chore: update ${SERVICE} image to ${IMAGE_TAG}"
git push
```

---

## Phase 5: ArgoCD Application 생성

### 5.1 App-of-Apps 패턴

**파일**: `argocd-apps/app-of-apps.yaml`
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: flash-tickets-apps
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/your-org/flash-tickets-gitops
    targetRevision: HEAD
    path: argocd-apps
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

### 5.2 서비스별 Application

**파일**: `argocd-apps/api-app.yaml`
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: flash-tickets-api
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/your-org/flash-tickets-gitops
    targetRevision: HEAD
    path: apps/api/overlays/prod
  destination:
    server: https://kubernetes.default.svc
    namespace: flash-tickets-prod
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas  # HPA 관리
```

### 5.3 Sync Wave 설정 (의존성 순서)
```yaml
# infrastructure → secrets → services
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "0"  # infrastructure
    argocd.argoproj.io/sync-wave: "1"  # secrets
    argocd.argoproj.io/sync-wave: "2"  # api
    argocd.argoproj.io/sync-wave: "3"  # gateway/pay
```

---

## Phase 6: 환경별 배포 전략

### 6.1 네임스페이스 분리
```yaml
# infrastructure/namespaces/namespaces.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: flash-tickets-dev
---
apiVersion: v1
kind: Namespace
metadata:
  name: flash-tickets-staging
---
apiVersion: v1
kind: Namespace
metadata:
  name: flash-tickets-prod
```

### 6.2 환경별 ArgoCD Projects
```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: flash-tickets-prod
  namespace: argocd
spec:
  description: Flash Tickets Production
  sourceRepos:
    - https://github.com/your-org/flash-tickets-gitops
  destinations:
    - namespace: flash-tickets-prod
      server: https://kubernetes.default.svc
  clusterResourceWhitelist:
    - group: '*'
      kind: '*'
```

### 6.3 프로모션 전략
```
dev (자동 배포) → staging (자동 배포 + 테스트) → prod (수동 승인)
```

---

## Phase 7: 모니터링 및 알림

### 7.1 ArgoCD Notifications

**설치**:
```bash
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/argocd-notifications/stable/manifests/install.yaml
```

**Slack 연동**:
```yaml
# argocd-notifications-cm.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  service.slack: |
    token: $slack-token
  template.app-deployed: |
    message: |
      Application {{.app.metadata.name}} has been deployed!
      Sync Status: {{.app.status.sync.status}}
      Health Status: {{.app.status.health.status}}
  trigger.on-deployed: |
    - when: app.status.operationState.phase in ['Succeeded']
      send: [app-deployed]
```

### 7.2 Prometheus & Grafana
- ArgoCD 메트릭 수집
- 배포 빈도, 실패율 대시보드
- MTTR(Mean Time To Recovery) 추적

---

## Phase 8: 롤백 및 재해 복구

### 8.1 자동 롤백 설정
```yaml
spec:
  syncPolicy:
    automated:
      selfHeal: true  # 드리프트 자동 수정
    retry:
      limit: 5
      backoff:
        duration: 5s
```

### 8.2 수동 롤백 스크립트
```bash
# scripts/rollback.sh
#!/bin/bash
SERVICE=$1
REVISION=$2  # ArgoCD history revision number

argocd app rollback flash-tickets-${SERVICE} ${REVISION}
argocd app wait flash-tickets-${SERVICE} --health
```

### 8.3 재해 복구 계획
- GitOps 저장소 백업 (GitHub 자동 백업)
- ArgoCD 설정 백업 (etcd snapshot)
- 이미지 레지스트리 백업 (ECR 리텐션 정책)

---

## 작업 우선순위 및 타임라인

### Week 1: 기반 구축
- [ ] ArgoCD 설치 및 Ingress 설정
- [ ] GitOps 저장소 생성 및 구조 설계
- [ ] Sealed Secrets 설치

### Week 2: 매니페스트 마이그레이션
- [ ] API 서비스 Kustomize 구조 변환
- [ ] Gateway, Pay, Web 서비스 변환
- [ ] Secret 암호화 및 SealedSecret 변환

### Week 3: CI/CD 파이프라인
- [ ] GitHub Actions 워크플로우 작성
- [ ] ECR 푸시 및 이미지 태깅 전략 구현
- [ ] GitOps 저장소 자동 업데이트 스크립트

### Week 4: ArgoCD 통합
- [ ] App-of-Apps 패턴 구현
- [ ] 서비스별 ArgoCD Application 생성
- [ ] Dev 환경 배포 테스트

### Week 5: 고도화
- [ ] Staging/Prod 환경 구성
- [ ] ArgoCD Notifications 설정
- [ ] 모니터링 대시보드 구축

---

## 체크리스트

### 보안
- [ ] Secret을 평문으로 Git에 커밋하지 않음
- [ ] ECR 이미지 스캔 활성화
- [ ] RBAC 적절히 설정
- [ ] ServiceAccount 권한 최소화

### 안정성
- [ ] 모든 Pod에 liveness/readiness probe 설정
- [ ] Resource requests/limits 설정
- [ ] HPA 설정 (필요 시)
- [ ] PDB (Pod Disruption Budget) 설정

### 관찰성
- [ ] 로그 중앙 집중화 (CloudWatch Logs)
- [ ] Prometheus 메트릭 수집
- [ ] Grafana 대시보드 구성
- [ ] 알림 채널 설정 (Slack/PagerDuty)

### 문서화
- [ ] ArgoCD 운영 가이드 작성
- [ ] 배포 프로세스 문서화
- [ ] 트러블슈팅 가이드 작성
- [ ] 롤백 절차 문서화

---

## 참고 자료

- [ArgoCD 공식 문서](https://argo-cd.readthedocs.io/)
- [Kustomize 가이드](https://kustomize.io/)
- [Sealed Secrets](https://github.com/bitnami-labs/sealed-secrets)
- [GitOps 베스트 프랙티스](https://www.weave.works/technologies/gitops/)
