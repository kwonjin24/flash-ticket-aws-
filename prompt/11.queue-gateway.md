# Queue Gateway 분리 작업 정리

## 변경 요약
- 기존 `api` 서비스 내부에 함께 존재하던 대기열 REST/WebSocket이 `gateway` 워크스페이스로 분리되었습니다.
- `libs/queue` 공용 모듈에서 Redis 기반 큐 로직을 제공하며, `api`와 `gateway`가 함께 사용합니다.
- Nginx 라우팅과 Docker 빌드 스크립트가 `flash-tickets-queue` 이미지를 인식하도록 수정되었습니다.

## 새 서버 엔드포인트
- REST Base URL: `/auth`
  - `POST /auth/register`
  - `POST /auth/register/admin`
  - `POST /auth/login` → `{ accessToken, refreshToken }`
  - `POST /auth/refresh` → `{ accessToken, refreshToken }`
  - `POST /auth/logout`
- REST Base URL: `/queue`
  - `POST /queue/enqueue` (JWT 필요)
  - `GET /queue/status?ticketId=...`
  - `POST /queue/enter` (JWT 필요)
- WebSocket: `socket.io` namespace `queue` (예: `wss://api.highgarden.cloud/socket.io/?EIO=4&transport=websocket&namespace=queue`)

## WebSocket 이벤트
- 서버 → 클라이언트
  - `queue:config` { `readyCapacity` }
  - `queue:update` { `ticketId`, `eventId`, `queueSize`, `readyCapacity`, `state`, `position`, `gateToken?` }
  - `queue:summary` { `eventId`, `queueSize`, `readyCapacity` }
  - `queue:error` { `message` }
  - `queue:left`
- 클라이언트 → 서버
  - `queue/join` { `userId`, `eventId?` }
  - `queue/leave` { `clearTicket?` }

## 프런트 TODO
1. **API Base 재설정**  
   - REST 호출 시 `api` 서비스가 아닌 `gateway` 라우팅(`/queue`)을 사용.
2. **WebSocket 연결 갱신**  
   - namespace: `'queue'`
   - 환경 별 URL: 동일 도메인(`api.highgarden.cloud`)의 `/socket.io/`.
3. **로그인 & 대기열 호출 대상 통합**  
   - `/auth/*` & `/queue/*` 모두 Gateway로 라우팅. 로그인 직후 받은 토큰을 그대로 대기열 호출에 사용.
4. **토큰 보관 & 갱신 흐름 점검**  
   - `refreshToken` 사용 시에도 Gateway `/auth/refresh` 호출.
5. **분리된 헬스체크/환경 변수 반영**  
   - `.env` 혹은 구성 파일에 `QUEUE_GATEWAY_BASE_URL`, `QUEUE_SOCKET_URL`, `AUTH_BASE_URL` 등을 정의.
