# 14. Queue Gateway 고가용성 개선 플랜

## 목표
- 큐 승격 작업을 단일 파드가 수행하도록 하고, 장애 발생 시 보조 파드가 자동으로 승격을 이어받도록 구성한다.
- 웹소켓 세션은 Redis에서 읽어오는 구조를 유지하며, 추가적인 스티키 세션이나 브로드캐스트 어댑터 없이도 정상 동작하도록 검증한다.

## 작업 항목
1. **분산 잠금 기반 승격 제어**
   - `QueuePromotionProcessor`에서 `promoteTickets()` 호출 전에 Redis 기반 잠금을 획득하도록 변경한다.
   - Redlock(또는 동일한 TTL 기반 잠금)을 적용하여 승격 파드가 주기적으로 잠금을 갱신하고, 잠금 만료 시 다른 파드가 승격을 담당할 수 있도록 한다.
   - 잠금 실패 시에는 승격을 생략하고 로그만 남긴 뒤 다음 주기를 기다리도록 구현한다.

2. **장애 자동 승계**
   - 기존 승격 파드가 비정상 종료되거나 잠금을 갱신하지 못해 잠금이 만료되면, 보조 파드가 잠금을 획득하여 즉시 승격을 이어받도록 한다.
   - 잠금 획득/갱신에 실패했을 때 경고 로그를 남겨 운영자가 파드 상태를 확인할 수 있게 한다.

3. **웹소켓 처리 검증**
   - 각 파드가 Redis에서 동일한 대기열 데이터를 읽어 클라이언트에 전달하면 되므로, 현재 구조(메모리 컨텍스트 + Redis 조회)로 다중 파드 환경에서도 문제 없는지 테스트한다.
   - 필요 시 문서화하여 스티키 세션 없이도 기대 동작을 설명한다.

## 확인 사항
- 잠금 해제 실패 시(예: Redis 오류) 일정 시간 후 다른 파드가 승격을 재개할 수 있는지 테스트한다.
- 승격 파드가 교체되는 동안에도 큐 상태가 일관되게 유지되는지, 중복 승격이 발생하지 않는지 확인한다.
